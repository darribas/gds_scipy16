
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>ESDA with PySAL Â· Geographic Data Science with PySAL and the pydata stack</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.1.1">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="05_spatial_dynamics.html" />
    
    
    <link rel="prev" href="03_spatial_weights.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../distribution.html">
            
                <a href="../distribution.html">
            
                    
                    Distribution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../content/about.html">
            
                <a href="../content/about.html">
            
                    
                    About the authors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../content/infrastructure/">
            
                <a href="../content/infrastructure/">
            
                    
                    Install guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../content/outline.html">
            
                <a href="../content/outline.html">
            
                    
                    Outline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../content/data/">
            
                <a href="../content/data/">
            
                    
                    Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../content/part1/">
            
                <a href="../content/part1/">
            
                    
                    Part I
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="01_data_processing.html">
            
                <a href="01_data_processing.html">
            
                    
                    Spatial data processing with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="02_geovisualization.html">
            
                <a href="02_geovisualization.html">
            
                    
                    Geovisualization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="03_spatial_weights.html">
            
                <a href="03_spatial_weights.html">
            
                    
                    Spatial weights in PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.4" data-path="04_esda.html">
            
                <a href="04_esda.html">
            
                    
                    ESDA with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="05_spatial_dynamics.html">
            
                <a href="05_spatial_dynamics.html">
            
                    
                    Space-time analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../content/part2/">
            
                <a href="../content/part2/">
            
                    
                    Part II
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="06_points.html">
            
                <a href="06_points.html">
            
                    
                    Points
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="07_spatial_clustering.html">
            
                <a href="07_spatial_clustering.html">
            
                    
                    Spatial clustering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="08_spatial_regression.html">
            
                <a href="08_spatial_regression.html">
            
                    
                    Spatial Regression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../content/infrastructure/workflow.html">
            
                <a href="../content/infrastructure/workflow.html">
            
                    
                    Development notes
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >ESDA with PySAL</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="exploratory-spatial-data-analysis-esda">Exploratory Spatial Data Analysis (ESDA)</h1>
<blockquote>
<p><a href="../content/part1/04_esda.ipynb"><code>IPYNB</code></a></p>
</blockquote>
<pre><code class="lang-python">%matplotlib inline
<span class="hljs-keyword">import</span> pysal <span class="hljs-keyword">as</span> ps
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> pysal.contrib.viz <span class="hljs-keyword">import</span> mapping <span class="hljs-keyword">as</span> maps
</code></pre>
<p>A well-used functionality in PySAL is the use of PySAL to conduct exploratory spatial data analysis. This notebook will provide an overview of ways to conduct exploratory spatial analysis in Python. </p>
<p>First, let&apos;s read in some data:</p>
<pre><code class="lang-python">data = ps.pdio.read_files(<span class="hljs-string">&quot;../data/texas.shp&quot;</span>)
</code></pre>
<pre><code class="lang-python">data.head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Lipscomb</td>
      <td>Texas</td>
      <td>48</td>
      <td>295</td>
      <td>48295</td>
      <td>48</td>
      <td>295</td>
      <td>48295</td>
      <td>1</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.031817</td>
      <td>0.286929</td>
      <td>0.378219</td>
      <td>0.407005</td>
      <td>0.373005</td>
      <td>6.724512</td>
      <td>4.5</td>
      <td>3.835360</td>
      <td>6.093580</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6da8ad...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Sherman</td>
      <td>Texas</td>
      <td>48</td>
      <td>421</td>
      <td>48421</td>
      <td>48</td>
      <td>421</td>
      <td>48421</td>
      <td>1</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.139958</td>
      <td>0.288976</td>
      <td>0.359377</td>
      <td>0.415453</td>
      <td>0.378041</td>
      <td>5.665722</td>
      <td>1.7</td>
      <td>3.253796</td>
      <td>3.869407</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6da8ad...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Dallam</td>
      <td>Texas</td>
      <td>48</td>
      <td>111</td>
      <td>48111</td>
      <td>48</td>
      <td>111</td>
      <td>48111</td>
      <td>1</td>
      <td>0.0</td>
      <td>...</td>
      <td>2.050906</td>
      <td>0.331667</td>
      <td>0.385996</td>
      <td>0.370037</td>
      <td>0.376015</td>
      <td>7.546049</td>
      <td>7.2</td>
      <td>9.471366</td>
      <td>14.231738</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6da8ad...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Hansford</td>
      <td>Texas</td>
      <td>48</td>
      <td>195</td>
      <td>48195</td>
      <td>48</td>
      <td>195</td>
      <td>48195</td>
      <td>1</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.253527</td>
      <td>0.357813</td>
      <td>0.393938</td>
      <td>0.383924</td>
      <td>7.591786</td>
      <td>4.7</td>
      <td>5.542986</td>
      <td>7.125457</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6da8ad...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Ochiltree</td>
      <td>Texas</td>
      <td>48</td>
      <td>357</td>
      <td>48357</td>
      <td>48</td>
      <td>357</td>
      <td>48357</td>
      <td>1</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.021911</td>
      <td>0.236998</td>
      <td>0.352940</td>
      <td>0.343949</td>
      <td>0.374461</td>
      <td>5.172414</td>
      <td>4.0</td>
      <td>4.758392</td>
      <td>9.159159</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6da8ad...</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-keyword">import</span> geopandas <span class="hljs-keyword">as</span> gpd
shp_link = <span class="hljs-string">&quot;../data/texas.shp&quot;</span>
tx = gpd.read_file(shp_link)
hr10 = ps.Quantiles(data.HR90, k=<span class="hljs-number">10</span>)
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))
tx.assign(cl=hr10.yb).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">10</span>, cmap=<span class="hljs-string">&apos;OrRd&apos;</span>, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;white&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.title(<span class="hljs-string">&quot;HR90 Deciles&quot;</span>)
plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_6_0.png" alt="png"></p>
<h2 id="spatial-autocorrelation">Spatial Autocorrelation</h2>
<p>Visual inspection of the map pattern for HR90 deciles allows us to search for spatial structure. If the spatial distribution of the rates was random, then we should not see any clustering of similar values on the map. However, our visual system is drawn to the darker clusters in the south west as well as the east, and a concentration of the lighter hues (lower homicide rates) moving north to the pan handle.</p>
<p>Our brains are very powerful pattern recognition machines. However, sometimes they can be too powerful and lead us to detect false positives, or patterns where there are no statistical patterns. This is a particular concern when dealing with visualization of irregular polygons of differning sizes and shapes.</p>
<p>The concept of <em>spatial autocorrelation</em> relates to the combination of two types of similarity: spatial similarity and attribute similarity. Although there are many different measures of spatial autocorrelation, they all combine these two types of simmilarity into a summary measure.</p>
<p>Let&apos;s use PySAL to generate these two types of similarity measures.</p>
<h3 id="spatial-similarity">Spatial Similarity</h3>
<p>We have already encountered spatial weights in a previous notebook. In spatial autocorrelation analysis, the spatial weights are used to formalize the notion of spatial similarity. As we have seen there are many ways to define spatial weights, here we will use queen contiguity:</p>
<pre><code class="lang-python">
data = ps.pdio.read_files(<span class="hljs-string">&quot;../data/texas.shp&quot;</span>)
W = ps.queen_from_shapefile(<span class="hljs-string">&quot;../data/texas.shp&quot;</span>)
W.transform = <span class="hljs-string">&apos;r&apos;</span>
</code></pre>
<h3 id="attribute-similarity">Attribute Similarity</h3>
<p>So the spatial weight between counties $i$ and $j$ indicates if the two counties are neighbors (i.e., geographically similar). What we also need is a measure of attribute similarity to pair up with this concept of spatial similarity.
The <strong>spatial lag</strong> is a derived variable that accomplishes this for us. For county $i$ the spatial lag is defined as:
<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mi>R</mi><mn>9</mn><mn>0</mn><mi>L</mi><mi>a</mi><msub><mi>g</mi><mi>i</mi></msub><mo>=</mo><msub><mo>&#x2211;</mo><mi>j</mi></msub><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mi>H</mi><mi>R</mi><mn>9</mn><msub><mn>0</mn><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">HR90Lag_i = \sum_j w_{i,j} HR90_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.186118em;vertical-align:-0.436118em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="mord mathrm">9</span><span class="mord mathrm">0</span><span class="mord mathit">L</span><span class="mord mathit">a</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span>&#x200B;</span></span></span><span class="mrel">=</span><span class="mop"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">&#x2211;</span><span class="vlist"><span style="top:0.30001em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span>&#x200B;</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span>&#x200B;</span></span></span><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="mord mathrm">9</span><span class="mord"><span class="mord mathrm">0</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">&#x200B;</span></span>&#x200B;</span></span></span></span></span></span></p>
<pre><code class="lang-python">HR90Lag = ps.lag_spatial(W, data.HR90)
</code></pre>
<pre><code class="lang-python">HR90LagQ10 = ps.Quantiles(HR90Lag, k=<span class="hljs-number">10</span>)
</code></pre>
<pre><code class="lang-python">f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))
tx.assign(cl=HR90LagQ10.yb).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">10</span>, cmap=<span class="hljs-string">&apos;OrRd&apos;</span>, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;white&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.title(<span class="hljs-string">&quot;HR90 Spatial Lag Deciles&quot;</span>)

plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_12_0.png" alt="png"></p>
<p>The decile map for the spatial lag tends to enhance the impression of value similarity in space. However, we still have the challenge of visually associating the value of the homicide rate in a county with the value of the spatial lag of rates for the county. The latter is a weighted average of homicide rates in the focal county&apos;s neighborhood.</p>
<p>To complement the geovisualization of these associations we can turn to formal statistical measures of spatial autocorrelation.</p>
<pre><code class="lang-python">HR90 = data.HR90
b,a = np.polyfit(HR90, HR90Lag, <span class="hljs-number">1</span>)
</code></pre>
<pre><code class="lang-python">f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))

plt.plot(HR90, HR90Lag, <span class="hljs-string">&apos;.&apos;</span>, color=<span class="hljs-string">&apos;firebrick&apos;</span>)

 <span class="hljs-comment"># dashed vert at mean of the last year&apos;s PCI</span>
plt.vlines(HR90.mean(), HR90Lag.min(), HR90Lag.max(), linestyle=<span class="hljs-string">&apos;--&apos;</span>)
 <span class="hljs-comment"># dashed horizontal at mean of lagged PCI</span>
plt.hlines(HR90Lag.mean(), HR90.min(), HR90.max(), linestyle=<span class="hljs-string">&apos;--&apos;</span>)

<span class="hljs-comment"># red line of best fit using global I as slope</span>
plt.plot(HR90, a + b*HR90, <span class="hljs-string">&apos;r&apos;</span>)
plt.title(<span class="hljs-string">&apos;Moran Scatterplot&apos;</span>)
plt.ylabel(<span class="hljs-string">&apos;Spatial Lag of HR90&apos;</span>)
plt.xlabel(<span class="hljs-string">&apos;HR90&apos;</span>)
plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_15_0.png" alt="png"></p>
<h2 id="global-spatial-autocorrelation">Global Spatial Autocorrelation</h2>
<p>In PySAL, commonly-used analysis methods are very easy to access. For example, if we were interested in examining the spatial dependence in <code>HR90</code> we could quickly compute a Moran&apos;s $I$ statistic:</p>
<pre><code class="lang-python">I_HR90 = ps.Moran(data.HR90.values, W)
</code></pre>
<pre><code class="lang-python">I_HR90.I, I_HR90.p_sim
</code></pre>
<pre><code>(0.085976640313889768, 0.012999999999999999)
</code></pre><p>Thus, the $I$ statistic is $0.859$ for this data, and has a very small $p$ value. </p>
<pre><code class="lang-python">b <span class="hljs-comment"># note I is same as the slope of the line in the scatterplot</span>
</code></pre>
<pre><code>0.085976640313889505
</code></pre><p>We can visualize the distribution of simulated $I$ statistics using the stored collection of simulated statistics:</p>
<pre><code class="lang-python">I_HR90.sim[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]
</code></pre>
<pre><code>array([-0.05640543, -0.03158917,  0.0277026 ,  0.03998822, -0.01140814])
</code></pre><p>A simple way to visualize this distribution is to make a KDEplot (like we&apos;ve done before), and add a rug showing all of the simulated points, and a vertical line denoting the observed value of the statistic:</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
%matplotlib inline
</code></pre>
<pre><code class="lang-python">sns.kdeplot(I_HR90.sim, shade=<span class="hljs-keyword">True</span>)
plt.vlines(I_HR90.sim, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>)
plt.vlines(I_HR90.I, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-string">&apos;r&apos;</span>)
plt.xlim([<span class="hljs-number">-0.15</span>, <span class="hljs-number">0.15</span>])
</code></pre>
<pre><code>/home/serge/anaconda2/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j





(-0.15, 0.15)
</code></pre><p><img src="04_esda_files/04_esda_26_2.png" alt="png"></p>
<p>Instead, if our $I$ statistic were close to our expected value, <code>I_HR90.EI</code>, our plot might look like this:</p>
<pre><code class="lang-python">sns.kdeplot(I_HR90.sim, shade=<span class="hljs-keyword">True</span>)
plt.vlines(I_HR90.sim, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
plt.vlines(I_HR90.EI+<span class="hljs-number">.01</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-string">&apos;r&apos;</span>)
plt.xlim([<span class="hljs-number">-0.15</span>, <span class="hljs-number">0.15</span>])
</code></pre>
<pre><code>/home/serge/anaconda2/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j





(-0.15, 0.15)
</code></pre><p><img src="04_esda_files/04_esda_28_2.png" alt="png"></p>
<p>The result of applying Moran&apos;s I is that we conclude the map pattern is not spatially random, but instead there is a signficant spatial association in homicide rates in Texas counties in 1990.</p>
<p>This result applies to the map as a whole, and is sometimes referred to as &quot;global spatial autocorrelation&quot;. Next we turn to a local analysis where the attention shifts to detection of hot spots, cold spots and spatial outliers.</p>
<h2 id="local-autocorrelation-statistics">Local Autocorrelation Statistics</h2>
<p>In addition to the Global autocorrelation statistics, PySAL has many local autocorrelation statistics. Let&apos;s compute a local Moran statistic for the same data shown above:</p>
<pre><code class="lang-python">LMo_HR90 = ps.Moran_Local(data.HR90.values, W)
</code></pre>
<p>Now, instead of a single $I$ statistic, we have an <em>array</em> of local $I_i$ statistics, stored in the <code>.Is</code> attribute, and p-values from the simulation are in <code>p_sim</code>. </p>
<pre><code class="lang-python">LMo_HR90.Is[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>], LMo_HR90.p_sim[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>(array([ 1.12087323,  0.47485223, -1.22758423,  0.93868661,  0.68974296,
         0.78503173,  0.71047515,  0.41060686,  0.00740368,  0.14866352]),
 array([ 0.013,  0.169,  0.037,  0.015,  0.002,  0.009,  0.053,  0.063,
         0.489,  0.119]))
</code></pre><p>We can adjust the number of permutations used to derive every <em>pseudo</em>-$p$ value by passing a different <code>permutations</code> argument:</p>
<pre><code class="lang-python">LMo_HR90 = ps.Moran_Local(data.HR90.values, W, permutations=<span class="hljs-number">9999</span>)
</code></pre>
<p>In addition to the typical clustermap, a helpful visualization for LISA statistics is a Moran scatterplot with statistically significant LISA values highlighted. </p>
<p>This is very simple, if we use the same strategy we used before:</p>
<p>First, construct the spatial lag of the covariate:</p>
<pre><code class="lang-python">Lag_HR90 = ps.lag_spatial(W, data.HR90.values)
HR90 = data.HR90.values
</code></pre>
<p>Then, we want to plot the statistically-significant LISA values in a different color than the others. To do this, first find all of the statistically significant LISAs. Since the $p$-values are in the same order as the $I_i$ statistics, we can do this in the following way</p>
<pre><code class="lang-python">sigs = HR90[LMo_HR90.p_sim &lt;= <span class="hljs-number">.001</span>]
W_sigs = Lag_HR90[LMo_HR90.p_sim &lt;= <span class="hljs-number">.001</span>]
insigs = HR90[LMo_HR90.p_sim &gt; <span class="hljs-number">.001</span>]
W_insigs = Lag_HR90[LMo_HR90.p_sim &gt; <span class="hljs-number">.001</span>]
</code></pre>
<p>Then, since we have a lot of points, we can plot the points with a statistically insignficant LISA value lighter using the <code>alpha</code> keyword. In addition, we would like to plot the statistically significant points in a dark red color. </p>
<pre><code class="lang-python">b,a = np.polyfit(HR90, Lag_HR90, <span class="hljs-number">1</span>)
</code></pre>
<p>Matplotlib has a list of <a href="http://matplotlib.org/examples/color/named_colors.html" target="_blank">named colors</a> and will interpret colors that are provided in hexadecimal strings:</p>
<pre><code class="lang-python">plt.plot(sigs, W_sigs, <span class="hljs-string">&apos;.&apos;</span>, color=<span class="hljs-string">&apos;firebrick&apos;</span>)
plt.plot(insigs, W_insigs, <span class="hljs-string">&apos;.k&apos;</span>, alpha=<span class="hljs-number">.2</span>)
 <span class="hljs-comment"># dashed vert at mean of the last year&apos;s PCI</span>
plt.vlines(HR90.mean(), Lag_HR90.min(), Lag_HR90.max(), linestyle=<span class="hljs-string">&apos;--&apos;</span>)
 <span class="hljs-comment"># dashed horizontal at mean of lagged PCI</span>
plt.hlines(Lag_HR90.mean(), HR90.min(), HR90.max(), linestyle=<span class="hljs-string">&apos;--&apos;</span>)

<span class="hljs-comment"># red line of best fit using global I as slope</span>
plt.plot(HR90, a + b*HR90, <span class="hljs-string">&apos;r&apos;</span>)
plt.text(s=<span class="hljs-string">&apos;$I = %.3f$&apos;</span> % I_HR90.I, x=<span class="hljs-number">50</span>, y=<span class="hljs-number">15</span>, fontsize=<span class="hljs-number">18</span>)
plt.title(<span class="hljs-string">&apos;Moran Scatterplot&apos;</span>)
plt.ylabel(<span class="hljs-string">&apos;Spatial Lag of HR90&apos;</span>)
plt.xlabel(<span class="hljs-string">&apos;HR90&apos;</span>)
</code></pre>
<pre><code>&lt;matplotlib.text.Text at 0x7fd6cf324d30&gt;
</code></pre><p><img src="04_esda_files/04_esda_44_1.png" alt="png"></p>
<p>We can also make a LISA map of the data. </p>
<pre><code class="lang-python">sig = LMo_HR90.p_sim &lt; <span class="hljs-number">0.05</span>
</code></pre>
<pre><code class="lang-python">sig.sum()
</code></pre>
<pre><code>44
</code></pre><pre><code class="lang-python">hotspots = LMo_HR90.q==<span class="hljs-number">1</span> * sig
</code></pre>
<pre><code class="lang-python">hotspots.sum()
</code></pre>
<pre><code>10
</code></pre><pre><code class="lang-python">coldspots = LMo_HR90.q==<span class="hljs-number">3</span> * sig
</code></pre>
<pre><code class="lang-python">coldspots.sum()
</code></pre>
<pre><code>17
</code></pre><pre><code class="lang-python">data.HR90[hotspots]
</code></pre>
<pre><code>98      9.784698
132    11.435106
164    17.129154
166    11.148272
209    13.274924
229    12.371338
234    31.721863
236     9.584971
239     9.256549
242    18.062652
Name: HR90, dtype: float64
</code></pre><pre><code class="lang-python">data[hotspots]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98</th>
      <td>Ellis</td>
      <td>Texas</td>
      <td>48</td>
      <td>139</td>
      <td>48139</td>
      <td>48</td>
      <td>139</td>
      <td>48139</td>
      <td>1</td>
      <td>9.217652</td>
      <td>...</td>
      <td>10.009746</td>
      <td>0.325785</td>
      <td>0.365177</td>
      <td>0.352516</td>
      <td>0.372783</td>
      <td>12.418831</td>
      <td>10.5</td>
      <td>9.076165</td>
      <td>12.031635</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc81a...</td>
    </tr>
    <tr>
      <th>132</th>
      <td>Hudspeth</td>
      <td>Texas</td>
      <td>48</td>
      <td>229</td>
      <td>48229</td>
      <td>48</td>
      <td>229</td>
      <td>48229</td>
      <td>1</td>
      <td>9.971084</td>
      <td>...</td>
      <td>0.514580</td>
      <td>0.312484</td>
      <td>0.373474</td>
      <td>0.440944</td>
      <td>0.476631</td>
      <td>14.115899</td>
      <td>7.7</td>
      <td>8.959538</td>
      <td>11.363636</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7a1...</td>
    </tr>
    <tr>
      <th>164</th>
      <td>Jeff Davis</td>
      <td>Texas</td>
      <td>48</td>
      <td>243</td>
      <td>48243</td>
      <td>48</td>
      <td>243</td>
      <td>48243</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.359712</td>
      <td>0.316019</td>
      <td>0.367719</td>
      <td>0.437014</td>
      <td>0.399655</td>
      <td>14.438503</td>
      <td>10.1</td>
      <td>5.970149</td>
      <td>8.255159</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7ae...</td>
    </tr>
    <tr>
      <th>166</th>
      <td>Schleicher</td>
      <td>Texas</td>
      <td>48</td>
      <td>413</td>
      <td>48413</td>
      <td>48</td>
      <td>413</td>
      <td>48413</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.903010</td>
      <td>0.300170</td>
      <td>0.387936</td>
      <td>0.419192</td>
      <td>0.419375</td>
      <td>10.155148</td>
      <td>9.8</td>
      <td>7.222914</td>
      <td>8.363636</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7ae...</td>
    </tr>
    <tr>
      <th>209</th>
      <td>Chambers</td>
      <td>Texas</td>
      <td>48</td>
      <td>071</td>
      <td>48071</td>
      <td>48</td>
      <td>71</td>
      <td>48071</td>
      <td>1</td>
      <td>3.211613</td>
      <td>...</td>
      <td>12.694146</td>
      <td>0.299847</td>
      <td>0.374105</td>
      <td>0.378431</td>
      <td>0.364723</td>
      <td>9.462037</td>
      <td>9.2</td>
      <td>8.568120</td>
      <td>10.598911</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7bb...</td>
    </tr>
    <tr>
      <th>229</th>
      <td>Frio</td>
      <td>Texas</td>
      <td>48</td>
      <td>163</td>
      <td>48163</td>
      <td>48</td>
      <td>163</td>
      <td>48163</td>
      <td>1</td>
      <td>3.296414</td>
      <td>...</td>
      <td>1.358373</td>
      <td>0.390980</td>
      <td>0.463020</td>
      <td>0.435098</td>
      <td>0.473507</td>
      <td>14.665445</td>
      <td>9.4</td>
      <td>11.842919</td>
      <td>18.330362</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7c2...</td>
    </tr>
    <tr>
      <th>234</th>
      <td>La Salle</td>
      <td>Texas</td>
      <td>48</td>
      <td>283</td>
      <td>48283</td>
      <td>48</td>
      <td>283</td>
      <td>48283</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>1.008755</td>
      <td>0.421556</td>
      <td>0.482174</td>
      <td>0.489173</td>
      <td>0.492687</td>
      <td>18.167702</td>
      <td>14.1</td>
      <td>13.052937</td>
      <td>20.088626</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7c2...</td>
    </tr>
    <tr>
      <th>236</th>
      <td>Dimmit</td>
      <td>Texas</td>
      <td>48</td>
      <td>127</td>
      <td>48127</td>
      <td>48</td>
      <td>127</td>
      <td>48127</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.575098</td>
      <td>0.417976</td>
      <td>0.452789</td>
      <td>0.456840</td>
      <td>0.479503</td>
      <td>13.826043</td>
      <td>10.1</td>
      <td>10.944363</td>
      <td>17.769080</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7c2...</td>
    </tr>
    <tr>
      <th>239</th>
      <td>Webb</td>
      <td>Texas</td>
      <td>48</td>
      <td>479</td>
      <td>48479</td>
      <td>48</td>
      <td>479</td>
      <td>48479</td>
      <td>1</td>
      <td>2.057899</td>
      <td>...</td>
      <td>0.117083</td>
      <td>0.382594</td>
      <td>0.443082</td>
      <td>0.439100</td>
      <td>0.461075</td>
      <td>20.292824</td>
      <td>15.5</td>
      <td>17.419676</td>
      <td>20.521271</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7c2...</td>
    </tr>
    <tr>
      <th>242</th>
      <td>Duval</td>
      <td>Texas</td>
      <td>48</td>
      <td>131</td>
      <td>48131</td>
      <td>48</td>
      <td>131</td>
      <td>48131</td>
      <td>1</td>
      <td>2.487934</td>
      <td>...</td>
      <td>0.092894</td>
      <td>0.370217</td>
      <td>0.427660</td>
      <td>0.421041</td>
      <td>0.458937</td>
      <td>15.829478</td>
      <td>13.2</td>
      <td>12.803677</td>
      <td>20.699881</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x7fd6cc7c2...</td>
    </tr>
  </tbody>
</table>
<p>10 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python"><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> colors
hmap = colors.ListedColormap([<span class="hljs-string">&apos;grey&apos;</span>, <span class="hljs-string">&apos;red&apos;</span>])
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))
tx.assign(cl=hotspots*<span class="hljs-number">1</span>).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">2</span>, cmap=hmap, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;grey&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_54_0.png" alt="png"></p>
<pre><code class="lang-python">data.HR90[coldspots]
</code></pre>
<pre><code>0      0.000000
3      0.000000
4      3.651767
5      0.000000
13     5.669899
19     3.480743
21     3.675119
32     2.211607
33     4.718762
48     5.509870
51     0.000000
62     3.677958
69     0.000000
81     0.000000
87     3.699593
140    8.125292
233    5.304688
Name: HR90, dtype: float64
</code></pre><pre><code class="lang-python">cmap = colors.ListedColormap([<span class="hljs-string">&apos;grey&apos;</span>, <span class="hljs-string">&apos;blue&apos;</span>])
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))
tx.assign(cl=coldspots*<span class="hljs-number">1</span>).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">2</span>, cmap=cmap, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;black&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_56_0.png" alt="png"></p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> colors
hcmap = colors.ListedColormap([<span class="hljs-string">&apos;grey&apos;</span>, <span class="hljs-string">&apos;red&apos;</span>,<span class="hljs-string">&apos;blue&apos;</span>])
hotcold = hotspots*<span class="hljs-number">1</span> + coldspots*<span class="hljs-number">2</span>
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">9</span>, <span class="hljs-number">9</span>))
tx.assign(cl=hotcold).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">2</span>, cmap=hcmap,linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;black&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.show()
</code></pre>
<p><img src="04_esda_files/04_esda_57_0.png" alt="png"></p>
<pre><code class="lang-python">sns.kdeplot(data.HR90)
</code></pre>
<pre><code>/home/serge/anaconda2/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j





&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fd6ccc17358&gt;
</code></pre><p><img src="04_esda_files/04_esda_58_2.png" alt="png"></p>
<pre><code class="lang-python">sns.kdeplot(data.HR90)
sns.kdeplot(data.HR80)
sns.kdeplot(data.HR70)
sns.kdeplot(data.HR60)
</code></pre>
<pre><code>/home/serge/anaconda2/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j





&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fd6da838908&gt;
</code></pre><p><img src="04_esda_files/04_esda_59_2.png" alt="png"></p>
<pre><code class="lang-python">data.HR90.mean()
</code></pre>
<pre><code>8.302494460285041
</code></pre><pre><code class="lang-python">data.HR90.median()
</code></pre>
<pre><code>7.23234613355
</code></pre><h2 id="exercises">Exercises</h2>
<ol>
<li>Repeat the global analysis for the years 1960, 70, 80 and compare the results to what we found in 1990.</li>
<li>The local analysis can also be repeated for the other decades. How many counties are hot spots in each of the periods?</li>
<li>The recent <a href="http://www.bbc.com/news/uk-politics-32810887" target="_blank">Brexit vote</a> provides a timely example where local spatial autocorrelation analysis can provide interesting insights.  One <a href="https://gist.github.com/darribas/691ad184280590d1219ffcf9a1678030" target="_blank">local analysis of the vote to leave</a> has recently been repored. Extend this to do an analysis of the attribute <code>Pct_remain</code>. Do the hot spots for the leave vote concord with the cold spots for the remain vote?</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="03_spatial_weights.html" class="navigation navigation-prev " aria-label="Previous page: Spatial weights in PySAL">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="05_spatial_dynamics.html" class="navigation navigation-next " aria-label="Next page: Space-time analysis">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"ESDA with PySAL","level":"1.7.4","depth":2,"next":{"title":"Space-time analysis","level":"1.7.5","depth":2,"path":"ipynb_md/05_spatial_dynamics.md","ref":"ipynb_md/05_spatial_dynamics.md","articles":[]},"previous":{"title":"Spatial weights in PySAL","level":"1.7.3","depth":2,"path":"ipynb_md/03_spatial_weights.md","ref":"ipynb_md/03_spatial_weights.md","articles":[]},"dir":"ltr"},"config":{"plugins":["katex"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"katex":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Serif","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Geographic Data Science with PySAL and the pydata stack","gitbook":">=3.0.0","description":"Booklet with material for the workshop at Scipy'16"},"file":{"path":"ipynb_md/04_esda.md","mtime":"2016-07-12T14:27:38.000Z","type":"markdown"},"gitbook":{"version":"3.1.1","time":"2016-07-12T14:37:18.052Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

